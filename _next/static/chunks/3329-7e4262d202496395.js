"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3329],{43329:function(e,n,t){t.d(n,{t:function(){return MessageBlock}});var s=t(97458),a=t(18854),i=t(52983),l=t(91601),r=t(14830),c=t(72911),o=t(66706),d=t(33168),u=t(76560),m=t(15960),g=t(15886),h=t(50606),x=t(85272),p=t(33569),f=t(79696),v=t(6604),j=t(55544),w=t(86057),b=t(42159),y=t.n(b),_=t(48748),k=t(51129),N=t(3265),z=t(56438),I=t(4602),R=t(98846),C=t(85273),E=t(1295);let KeyInButton=e=>{let{children:n,className:t}=e;return(0,s.jsx)("span",{className:(0,r.cn)("text-zinc-500 dark:text-zinc-400 bg-zinc-200 dark:bg-zinc-700 rounded px-[3px] text-xs font-medium",t),children:n})},stripAnsi=e=>e.replace(/[\u001B\u009B][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g,""),MessageBlock=e=>{var n;let{message:t,isResponding:b,scrollToBottom:y,retryFromCurrentMessage:_,editable:N,model:z,alwaysUseCredits:I}=e,{config:R}=(0,d.ZR)(),C="user"===t.role,S="system"===t.role,F=(0,i.useRef)(null),M=(0,i.useRef)(null),B=(0,a.useRouter)(),[T,K]=(0,i.useState)(!1),q=(0,u.b)(B.query.message&&B.isReady&&t.id===B.query.message,400),D=(0,c.F)(()=>t.content),[L,O]=(0,i.useState)(!1),P=(0,j.useTranslations)(),[U,A]=(0,i.useState)(""),G=(0,i.useRef)(null),[$,Z]=(0,i.useState)(t.renderFunctionResult||null),V=(0,d.EK)(),W=U||t.content,[J,Q]=(0,i.useState)(!1),H=k.e.useIsPlaying(t.id),X=k.e.useIsLoading(t.id),updateTextSelection=()=>{var e;let n=null===(e=window.getSelection())||void 0===e?void 0:e.toString().trim();n?A(n):U&&A("")},Y=(0,i.useMemo)(()=>{if(t.function_call)return V.find(e=>{var n;return e.name_for_model===(null===(n=t.function_call)||void 0===n?void 0:n.name)})},[V,t.function_call]);(0,i.useEffect)(()=>{null==y||y()},[y,t.content]),(0,i.useEffect)(()=>{if(q){var e;null===(e=F.current)||void 0===e||e.scrollIntoView()}},[q]),(0,i.useEffect)(()=>{t.renderFunctionResult&&null===$&&Z(!0)},[t.renderFunctionResult,$]),(0,w.t$)(G,()=>{A("")});let saveEdit=async()=>{M.current&&(await o.h.message.update(t.id,e=>{var n;return{...e,content:(null===(n=M.current)||void 0===n?void 0:n.value)||""}}),K(!1),"user"===t.role&&(null==_||_()))},ee=t.files||[],en=!!(t.content||ee.length>0);return t.content||0!==ee.length||t.function_call||b?"custom:ignore-messages"===t.role?(0,s.jsxs)("div",{ref:F,className:"relative my-10",children:[(0,s.jsx)("div",{className:"h-[1px] text-zinc-200 bg-zinc-100 dark:bg-zinc-700","aria-hidden":!0}),(0,s.jsxs)("button",{className:(0,r.cn)("text-zinc-400 dark:text-zinc-500 text-xs font-medium inline-flex items-center py-0.5 px-2 bg-white dark:bg-zinc-900 absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2",N?"hover:text-red-500 dark:hover:text-red-600 group/ignore-messages":"cursor-default"),onClick:()=>{o.h.message.delete(t.id)},children:[(0,s.jsx)("span",{className:"group-hover/ignore-messages:hidden",children:P("app.ignore_messages.message")}),(0,s.jsxs)("span",{className:"hidden group-hover/ignore-messages:inline-flex items-center gap-1",children:[(0,s.jsx)("span",{className:"i-tabler-trash"}),P("app.ignore_messages.delete_label")]})]})]}):(0,s.jsx)("div",{ref:F,className:(0,r.cn)("message group/message","user"===t.role&&"user-message"),children:(0,s.jsxs)("div",{className:(0,r.cn)("flex",C||S?"justify-end":""),children:["assistant"===t.role&&(0,s.jsx)(f.z,{model:(null==z?void 0:z.startsWith("custom:"))?"custom":z,className:"mr-2"}),(0,s.jsxs)("div",{className:"w-0 grow md:max-w-[80%] space-y-1 message-contents",children:[(b&&!t.function_call||en)&&(0,s.jsx)("div",{className:(0,r.cn)("flex break-words","user"===t.role&&"justify-end"),children:(0,s.jsxs)("div",{className:(0,r.cn)("rounded-2xl px-4 py-3 w-fit max-w-full overflow-auto",q&&"animate-in zoom-in-75",C||S?"bg-blue-500 text-white dark:bg-blue-600 dark:selection:bg-blue-900":"bg-zinc-100 dark:bg-zinc-800 dark:text-white"),children:[b&&!en&&(0,s.jsx)(p.$,{}),T?(0,s.jsx)(l.Z,{defaultValue:t.content,autoFocus:!0,ref:M,className:"bg-transparent outline-none resize-none min-w-[300px]",onKeyDown:e=>{e.metaKey&&"Enter"===e.key?(e.preventDefault(),saveEdit()):27===e.which&&K(!1)}}):(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{onMouseUp:updateTextSelection,onTouchEnd:updateTextSelection,ref:G,children:(0,s.jsx)(x.U,{content:t.content,isTyping:b,enabled:"user"!==t.role||R.markdown_enableInUserMessages})}),ee.length>0&&(0,s.jsx)("div",{className:(0,r.cn)("mt-2 grid gap-2",ee.length>1?"grid-cols-2":""),children:(0,s.jsx)(RenderImages,{images:ee})})]})]})}),t.function_call?(0,s.jsxs)("div",{children:[(0,s.jsxs)("button",{type:"button",className:"px-3 rounded-xl bg-zinc-100 dark:bg-zinc-800 h-10 inline-flex items-center gap-1 focus:ring ring-blue-500 disabled:pointer-events-none",disabled:b,onClick:()=>Z(e=>!e),children:[(0,s.jsx)("span",{children:null!==(n=null==Y?void 0:Y.name_for_human)&&void 0!==n?n:t.function_call.name}),b?(0,s.jsx)(p.$,{}):(0,s.jsx)("span",{className:(0,r.cn)("i-tabler-chevron-right transition",$&&"rotate-90")})]}),$&&void 0!==t.function_result&&(0,s.jsx)("div",{className:"mt-2 md:max-w-[80%]",children:t.renderFunctionResult?(0,s.jsx)("div",{className:"rounded-xl overflow-hidden select-auto cursor-auto",children:"chatkit_dalle"===t.function_call.name?(0,s.jsx)(RenderImages,{images:t.function_result.images}):"chatkit_calculator"===t.function_call.name?(0,s.jsx)("span",{children:t.function_result}):"chatkit_deno"===t.function_call.name?(0,s.jsx)("div",{className:"whitespace-pre-wrap",children:stripAnsi(t.function_result)}):null}):(0,s.jsxs)("div",{className:"p-3 bg-zinc-100 dark:bg-zinc-800 rounded-xl select-auto cursor-auto",children:[(0,s.jsxs)("div",{children:["Arguments: ",t.function_call.arguments]}),t.function_result&&(0,s.jsx)("div",{children:"Result:"}),t.function_result&&(0,s.jsx)("pre",{className:"w-full overflow-auto whitespace-pre-wrap",children:JSON.stringify(t.function_result,null,2)})]})})]}):(0,s.jsx)("div",{className:(0,r.cn)("message-tools group-hover/message:opacity-100 flex gap-1 -mb-3 flex-wrap","user"===t.role?"justify-end":"justify-start",!H&&!X&&"opacity-0"),"data-no-screenshot":!0,children:(0,s.jsxs)("div",{className:(0,r.cn)("flex items-center gap-1"),children:[_&&!b&&!T&&(0,s.jsx)(h.z,{type:"button",variant:"message_action",onPress:()=>{null==_||_()},children:(0,s.jsx)("span",{className:"assistant"===t.role?"i-lucide-fast-forward":"i-lucide-rotate-cw"})}),!T&&(0,s.jsx)(h.z,{type:"button",onClick:D.copy,variant:"message_action",children:(0,s.jsx)("span",{className:(0,r.cn)(D.copied?"i-lucide-check animate-in zoom-in-75 text-green-500":"i-lucide-clipboard"),title:"Copy"})}),N&&(0,s.jsx)(h.z,{type:"button",variant:"message_action",onPress:()=>{K(e=>!e)},children:T?(0,s.jsxs)("span",{children:[P("app.cancel"),(0,s.jsx)(KeyInButton,{className:"ml-1",children:"ESC"})]}):(0,s.jsx)("span",{className:"i-lucide-edit-3"})}),T&&(0,s.jsxs)(h.z,{type:"button",variant:"message_action",onClick:async()=>{saveEdit()},children:[P("user"===t.role?"app.save_and_submit":"app.save"),(0,s.jsx)(KeyInButton,{className:"ml-1",children:"âŒ˜Enter"})]}),N&&!T&&(0,s.jsxs)(E.hg,{isOpen:L,onOpenChange:O,children:[(0,s.jsx)(h.z,{type:"button",className:"text-red-500",variant:"message_action",onClick:()=>O(!0),children:(0,s.jsx)("span",{className:"i-lucide-trash-2"})}),(0,s.jsx)(v.Q,{isDanger:!0,title:P("delete_message.title"),desc:P("delete_message.desc"),onConfirm:async()=>{O(!1),await o.h.message.delete(t.id)}})]}),!b&&!T&&"assistant"===t.role&&!1!==R.tts_enabled&&(0,s.jsx)("div",{className:(0,r.cn)(""),id:"audio-wrapper-".concat(t.id),"data-no-screenshot":!0,children:(0,s.jsx)(g.z,{messageId:t.id,alwaysUseCredits:I,text:!1===R.tts_readEmoji?(0,m.S7)(W):W})}),t.duration&&!T?(0,s.jsx)(h.z,{type:"button",variant:"message_action",left:(0,s.jsx)("span",{className:"i-tabler-brand-speedtest mr-1"}),onClick:()=>Q(e=>!e),children:(0,s.jsx)(MessageTokenCount,{id:t.id,content:t.content,duration:t.duration,showDuration:!!(J||b)})}):null]})})]})]})}):null},shimmer=(e,n,t)=>{let s=t?"#333":"#e2e2e2";return'<svg  width="'.concat(e,'" height="').concat(n,'" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <defs>\n      <linearGradient id="g">\n        <stop stop-color="').concat(s,'" offset="20%" />\n        <stop stop-color="').concat(t?"#222":"#ccc",'" offset="50%" />\n        <stop stop-color="').concat(s,'" offset="70%" />\n      </linearGradient>\n    </defs>\n    <rect fill="').concat(t?"#333":"#e2e2e2",'" width="').concat(e,'" height="').concat(n,'" />\n    <rect id="r" width="').concat(e,'" height="').concat(n,'" fill="url(#g)" />\n    <animate xlink:href="#r" attributeName="x" from="-').concat(e,'" to="').concat(e,'" dur="1s" repeatCount="indefinite"  />\n  </svg>')},toBase64=e=>window.btoa(e),getImagePlaceholder=(e,n,t)=>{let s=shimmer(e,n,t);return"data:image/svg+xml;base64,".concat(toBase64(s))},RenderImages=e=>{let{images:n}=e;return(0,s.jsx)("div",{className:"flex flex-wrap gap-2",children:n.map(e=>(0,s.jsx)(RenderImageItem,{image:e},e.url))})},RenderImageItem=e=>{let{image:n}=e,t=(0,_.F)(),a=n.width&&n.height?getImagePlaceholder(n.width,n.height,"dark"===t):void 0,i=(0,N.D)({mutationFn:async e=>{let{url:n,filepath:t}=e,s=(0,C.EG)();await s.invoke("download_file",{url:n,filepath:t})},onError(e){(0,R._)(e)}}),l=(0,u.b)(i.isSuccess,1e3);return(0,s.jsxs)("div",{className:"relative group/image",children:[(0,s.jsx)("button",{type:"button","data-no-screenshot":!0,className:(0,r.cn)("absolute group-hover/image:inline-flex top-1 left-1 hidden items-center justify-center w-5 h-5 p-0 rounded-md text-white bg-zinc-800/60 hover:bg-zinc-800/80",(i.isLoading||l&&i.isSuccess)&&"inline-flex"),onClick:async()=>{let e=new URL(n.url).pathname.split(".").pop();{let t=document.createElement("a");t.href=n.url,t.download="image.".concat(e),t.click()}},disabled:i.isLoading,children:i.isLoading?(0,s.jsx)(p.$,{}):(0,s.jsx)("span",{className:(0,r.cn)(l&&i.isSuccess?"i-tabler-check text-green-500":"i-tabler-download")})}),(0,s.jsx)(y(),{alt:"Generated image",src:n.url,width:n.width,height:n.height,placeholder:a})]})},MessageTokenCount=e=>{let{id:n,showDuration:t,duration:a,content:i}=e,l=(0,z.a)({queryKey:["token-count",n,i],queryFn:async()=>{let e=await (0,I.I)(i);return e},refetchOnWindowFocus:!1,retry:!1,networkMode:"always",enabled:!t});return(0,s.jsx)("span",{children:t?"".concat(Math.floor(a/1e3),"s"):"".concat(l.data?Math.floor(l.data/(a/1e3)):0," \n  tokens/s")})}}}]);
